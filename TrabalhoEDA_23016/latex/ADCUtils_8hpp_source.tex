\doxysection{ADCUtils.\+hpp}
\hypertarget{ADCUtils_8hpp_source}{}\label{ADCUtils_8hpp_source}\index{C:/Users/danib/Documents/Arduino/libraries/IRremote/examples/AllProtocolsOnLCD/ADCUtils.hpp@{C:/Users/danib/Documents/Arduino/libraries/IRremote/examples/AllProtocolsOnLCD/ADCUtils.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{/*}}
\DoxyCodeLine{00002\ \textcolor{comment}{\ *\ ADCUtils.hpp}}
\DoxyCodeLine{00003\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00004\ \textcolor{comment}{\ *\ ADC\ utility\ functions.\ Conversion\ time\ is\ defined\ as\ 0.104\ milliseconds\ for\ 16\ MHz\ Arduinos\ in\ ADCUtils.h.}}
\DoxyCodeLine{00005\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00006\ \textcolor{comment}{\ *\ \ Copyright\ (C)\ 2016-\/2023\ \ Armin\ Joachimsmeyer}}
\DoxyCodeLine{00007\ \textcolor{comment}{\ *\ \ Email:\ armin.joachimsmeyer@gmail.com}}
\DoxyCodeLine{00008\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00009\ \textcolor{comment}{\ *\ \ This\ file\ is\ part\ of\ Arduino-\/Utils\ https://github.com/ArminJo/Arduino-\/Utils.}}
\DoxyCodeLine{00010\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00011\ \textcolor{comment}{\ *\ \ ArduinoUtils\ is\ free\ software:\ you\ can\ redistribute\ it\ and/or\ modify}}
\DoxyCodeLine{00012\ \textcolor{comment}{\ *\ \ it\ under\ the\ terms\ of\ the\ GNU\ General\ Public\ License\ as\ published\ by}}
\DoxyCodeLine{00013\ \textcolor{comment}{\ *\ \ the\ Free\ Software\ Foundation,\ either\ version\ 3\ of\ the\ License,\ or}}
\DoxyCodeLine{00014\ \textcolor{comment}{\ *\ \ (at\ your\ option)\ any\ later\ version.}}
\DoxyCodeLine{00015\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00016\ \textcolor{comment}{\ *\ \ This\ program\ is\ distributed\ in\ the\ hope\ that\ it\ will\ be\ useful,}}
\DoxyCodeLine{00017\ \textcolor{comment}{\ *\ \ but\ WITHOUT\ ANY\ WARRANTY;\ without\ even\ the\ implied\ warranty\ of}}
\DoxyCodeLine{00018\ \textcolor{comment}{\ *\ \ MERCHANTABILITY\ or\ FITNESS\ FOR\ A\ PARTICULAR\ PURPOSE.}}
\DoxyCodeLine{00019\ \textcolor{comment}{\ *\ \ See\ the\ GNU\ General\ Public\ License\ for\ more\ details.}}
\DoxyCodeLine{00020\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00021\ \textcolor{comment}{\ *\ \ You\ should\ have\ received\ a\ copy\ of\ the\ GNU\ General\ Public\ License}}
\DoxyCodeLine{00022\ \textcolor{comment}{\ *\ \ along\ with\ this\ program.\ If\ not,\ see\ <http://www.gnu.org/licenses/gpl.html>.}}
\DoxyCodeLine{00023\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#ifndef\ \_ADC\_UTILS\_HPP}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#define\ \_ADC\_UTILS\_HPP}}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ "{}ADCUtils.h"{}}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#if\ defined(ADC\_UTILS\_ARE\_AVAILABLE)\ }\textcolor{comment}{//\ set\ in\ ADCUtils.h,\ if\ supported\ architecture\ was\ detected}}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#if\ !defined(STR\_HELPER)}}
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\#define\ STR\_HELPER(x)\ \#x}}
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#define\ STR(x)\ STR\_HELPER(x)}}
\DoxyCodeLine{00034\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00035\ }
\DoxyCodeLine{00036\ \textcolor{comment}{/*}}
\DoxyCodeLine{00037\ \textcolor{comment}{\ *\ By\ replacing\ this\ value\ with\ the\ voltage\ you\ measured\ a\ the\ AREF\ pin\ after\ a\ conversion}}
\DoxyCodeLine{00038\ \textcolor{comment}{\ *\ with\ INTERNAL\ you\ can\ calibrate\ your\ ADC\ readout.\ For\ my\ Nanos\ I\ measured\ e.g.\ 1060\ mV\ and\ 1093\ mV.}}
\DoxyCodeLine{00039\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00040\ \textcolor{preprocessor}{\#if\ !defined(ADC\_INTERNAL\_REFERENCE\_MILLIVOLT)}}
\DoxyCodeLine{00041\ \textcolor{preprocessor}{\#define\ ADC\_INTERNAL\_REFERENCE\_MILLIVOLT\ \ \ \ 1100L\ }\textcolor{comment}{//\ Change\ to\ value\ measured\ at\ the\ AREF\ pin.\ If\ value\ >\ real\ AREF\ voltage,\ measured\ values\ are\ >\ real\ values}}
\DoxyCodeLine{00042\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00044\ \textcolor{comment}{//\ Union\ to\ speed\ up\ the\ combination\ of\ low\ and\ high\ bytes\ to\ a\ word}}
\DoxyCodeLine{00045\ \textcolor{comment}{//\ it\ is\ not\ optimal\ since\ the\ compiler\ still\ generates\ 2\ unnecessary\ moves}}
\DoxyCodeLine{00046\ \textcolor{comment}{//\ but\ using\ \ -\/-\/\ value\ =\ (high\ <<\ 8)\ |\ low\ -\/-\/\ gives\ 5\ unnecessary\ instructions}}
\DoxyCodeLine{00047\ \textcolor{keyword}{union\ }WordUnionForADCUtils\ \{}
\DoxyCodeLine{00048\ \ \ \ \ \textcolor{keyword}{struct\ }\{}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ uint8\_t\ LowByte;}
\DoxyCodeLine{00050\ \ \ \ \ \ \ \ \ uint8\_t\ HighByte;}
\DoxyCodeLine{00051\ \ \ \ \ \}\ UByte;}
\DoxyCodeLine{00052\ \ \ \ \ uint16\_t\ UWord;}
\DoxyCodeLine{00053\ \ \ \ \ int16\_t\ Word;}
\DoxyCodeLine{00054\ \ \ \ \ uint8\_t\ *BytePointer;}
\DoxyCodeLine{00055\ \};}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00057\ \textcolor{comment}{/*}}
\DoxyCodeLine{00058\ \textcolor{comment}{\ *\ Enable\ this\ to\ see\ information\ on\ each\ call.}}
\DoxyCodeLine{00059\ \textcolor{comment}{\ *\ Since\ there\ should\ be\ no\ library\ which\ uses\ Serial,\ it\ should\ only\ be\ enabled\ for\ development\ purposes.}}
\DoxyCodeLine{00060\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00061\ \textcolor{preprocessor}{\#if\ defined(DEBUG)\ \&\&\ !defined(LOCAL\_DEBUG)}}
\DoxyCodeLine{00062\ \textcolor{preprocessor}{\#define\ LOCAL\_DEBUG}}
\DoxyCodeLine{00063\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00064\ \textcolor{comment}{//\#define\ LOCAL\_DEBUG\ //\ This\ enables\ debug\ output\ only\ for\ this\ file}}
\DoxyCodeLine{00065\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \textcolor{comment}{/*}}
\DoxyCodeLine{00068\ \textcolor{comment}{\ *\ Persistent\ storage\ for\ VCC\ value}}
\DoxyCodeLine{00069\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00070\ \textcolor{keywordtype}{float}\ sVCCVoltage;}
\DoxyCodeLine{00071\ uint16\_t\ sVCCVoltageMillivolt;}
\DoxyCodeLine{00072\ }
\DoxyCodeLine{00073\ \textcolor{comment}{//\ for\ isVCCTooLowMultipleTimes()}}
\DoxyCodeLine{00074\ \textcolor{keywordtype}{long}\ sLastVCCCheckMillis;}
\DoxyCodeLine{00075\ uint8\_t\ sVCCTooLowCounter\ =\ 0;}
\DoxyCodeLine{00076\ }
\DoxyCodeLine{00077\ \textcolor{comment}{/*}}
\DoxyCodeLine{00078\ \textcolor{comment}{\ *\ Conversion\ time\ is\ defined\ as\ 0.104\ milliseconds\ by\ ADC\_PRESCALE\ in\ ADCUtils.h.}}
\DoxyCodeLine{00079\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00080\ uint16\_t\ readADCChannel(uint8\_t\ aADCChannelNumber)\ \{}
\DoxyCodeLine{00081\ \ \ \ \ WordUnionForADCUtils\ tUValue;}
\DoxyCodeLine{00082\ \ \ \ \ ADMUX\ =\ aADCChannelNumber\ |\ (DEFAULT\ <<\ SHIFT\_VALUE\_FOR\_REFERENCE);}
\DoxyCodeLine{00083\ }
\DoxyCodeLine{00084\ \ \ \ \ \textcolor{comment}{//\ ADCSRB\ =\ 0;\ //\ Only\ active\ if\ ADATE\ is\ set\ to\ 1.}}
\DoxyCodeLine{00085\ \ \ \ \ \textcolor{comment}{//\ ADSC-\/StartConversion\ ADIF-\/Reset\ Interrupt\ Flag\ -\/\ NOT\ free\ running\ mode}}
\DoxyCodeLine{00086\ \ \ \ \ ADCSRA\ =\ (\_BV(ADEN)\ |\ \_BV(ADSC)\ |\ \_BV(ADIF)\ |\ ADC\_PRESCALE);}
\DoxyCodeLine{00087\ }
\DoxyCodeLine{00088\ \ \ \ \ \textcolor{comment}{//\ wait\ for\ single\ conversion\ to\ finish}}
\DoxyCodeLine{00089\ \ \ \ \ loop\_until\_bit\_is\_clear(ADCSRA,\ ADSC);}
\DoxyCodeLine{00090\ }
\DoxyCodeLine{00091\ \ \ \ \ \textcolor{comment}{//\ Get\ value}}
\DoxyCodeLine{00092\ \ \ \ \ tUValue.UByte.LowByte\ =\ ADCL;}
\DoxyCodeLine{00093\ \ \ \ \ tUValue.UByte.HighByte\ =\ ADCH;}
\DoxyCodeLine{00094\ \ \ \ \ \textcolor{keywordflow}{return}\ tUValue.UWord;}
\DoxyCodeLine{00095\ \ \ \ \ \textcolor{comment}{//\ \ \ \ return\ ADCL\ |\ (ADCH\ <<8);\ //\ needs\ 4\ bytes\ more}}
\DoxyCodeLine{00096\ \}}
\DoxyCodeLine{00097\ }
\DoxyCodeLine{00098\ \textcolor{comment}{/*}}
\DoxyCodeLine{00099\ \textcolor{comment}{\ *\ Conversion\ time\ is\ defined\ as\ 0.104\ milliseconds\ by\ ADC\_PRESCALE\ in\ ADCUtils.h.}}
\DoxyCodeLine{00100\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00101\ uint16\_t\ readADCChannelWithReference(uint8\_t\ aADCChannelNumber,\ uint8\_t\ aReference)\ \{}
\DoxyCodeLine{00102\ \ \ \ \ WordUnionForADCUtils\ tUValue;}
\DoxyCodeLine{00103\ \ \ \ \ ADMUX\ =\ aADCChannelNumber\ |\ (aReference\ <<\ SHIFT\_VALUE\_FOR\_REFERENCE);}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00105\ \ \ \ \ \textcolor{comment}{//\ ADCSRB\ =\ 0;\ //\ Only\ active\ if\ ADATE\ is\ set\ to\ 1.}}
\DoxyCodeLine{00106\ \ \ \ \ \textcolor{comment}{//\ ADSC-\/StartConversion\ ADIF-\/Reset\ Interrupt\ Flag\ -\/\ NOT\ free\ running\ mode}}
\DoxyCodeLine{00107\ \ \ \ \ ADCSRA\ =\ (\_BV(ADEN)\ |\ \_BV(ADSC)\ |\ \_BV(ADIF)\ |\ ADC\_PRESCALE);}
\DoxyCodeLine{00108\ }
\DoxyCodeLine{00109\ \ \ \ \ \textcolor{comment}{//\ wait\ for\ single\ conversion\ to\ finish}}
\DoxyCodeLine{00110\ \ \ \ \ loop\_until\_bit\_is\_clear(ADCSRA,\ ADSC);}
\DoxyCodeLine{00111\ }
\DoxyCodeLine{00112\ \ \ \ \ \textcolor{comment}{//\ Get\ value}}
\DoxyCodeLine{00113\ \ \ \ \ tUValue.UByte.LowByte\ =\ ADCL;}
\DoxyCodeLine{00114\ \ \ \ \ tUValue.UByte.HighByte\ =\ ADCH;}
\DoxyCodeLine{00115\ \ \ \ \ \textcolor{keywordflow}{return}\ tUValue.UWord;}
\DoxyCodeLine{00116\ \}}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00118\ \textcolor{comment}{/*}}
\DoxyCodeLine{00119\ \textcolor{comment}{\ *\ Conversion\ time\ is\ defined\ as\ 0.104\ milliseconds\ by\ ADC\_PRESCALE\ in\ ADCUtils.h.}}
\DoxyCodeLine{00120\ \textcolor{comment}{\ *\ Does\ NOT\ restore\ ADMUX\ after\ reading}}
\DoxyCodeLine{00121\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00122\ uint16\_t\ waitAndReadADCChannelWithReference(uint8\_t\ aADCChannelNumber,\ uint8\_t\ aReference)\ \{}
\DoxyCodeLine{00123\ \ \ \ \ checkAndWaitForReferenceAndChannelToSwitch(aADCChannelNumber,\ aReference);}
\DoxyCodeLine{00124\ \ \ \ \ \textcolor{keywordflow}{return}\ readADCChannelWithReference(aADCChannelNumber,\ aReference);}
\DoxyCodeLine{00125\ \}}
\DoxyCodeLine{00126\ }
\DoxyCodeLine{00127\ \textcolor{comment}{/*}}
\DoxyCodeLine{00128\ \textcolor{comment}{\ *\ Conversion\ time\ is\ defined\ as\ 0.104\ milliseconds\ by\ ADC\_PRESCALE\ in\ ADCUtils.h.}}
\DoxyCodeLine{00129\ \textcolor{comment}{\ *\ Restores\ ADMUX\ after\ reading}}
\DoxyCodeLine{00130\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00131\ uint16\_t\ waitAndReadADCChannelWithReferenceAndRestoreADMUXAndReference(uint8\_t\ aADCChannelNumber,\ uint8\_t\ aReference)\ \{}
\DoxyCodeLine{00132\ \ \ \ \ uint8\_t\ tOldADMUX\ =\ checkAndWaitForReferenceAndChannelToSwitch(aADCChannelNumber,\ aReference);}
\DoxyCodeLine{00133\ \ \ \ \ uint16\_t\ tResult\ =\ readADCChannelWithReference(aADCChannelNumber,\ aReference);}
\DoxyCodeLine{00134\ \ \ \ \ checkAndWaitForReferenceAndChannelToSwitch(tOldADMUX\ \&\ MASK\_FOR\_ADC\_CHANNELS,\ tOldADMUX\ >>\ SHIFT\_VALUE\_FOR\_REFERENCE);}
\DoxyCodeLine{00135\ \ \ \ \ \textcolor{keywordflow}{return}\ tResult;}
\DoxyCodeLine{00136\ \}}
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00138\ \textcolor{comment}{/*}}
\DoxyCodeLine{00139\ \textcolor{comment}{\ *\ To\ prepare\ reference\ and\ ADMUX\ for\ next\ measurement}}
\DoxyCodeLine{00140\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00141\ \textcolor{keywordtype}{void}\ setADCChannelAndReferenceForNextConversion(uint8\_t\ aADCChannelNumber,\ uint8\_t\ aReference)\ \{}
\DoxyCodeLine{00142\ \ \ \ \ ADMUX\ =\ aADCChannelNumber\ |\ (aReference\ <<\ SHIFT\_VALUE\_FOR\_REFERENCE);}
\DoxyCodeLine{00143\ \}}
\DoxyCodeLine{00144\ }
\DoxyCodeLine{00145\ \textcolor{comment}{/*}}
\DoxyCodeLine{00146\ \textcolor{comment}{\ *\ @return\ original\ ADMUX\ register\ content\ for\ optional\ later\ restoring\ values}}
\DoxyCodeLine{00147\ \textcolor{comment}{\ *\ All\ experimental\ values\ are\ acquired\ by\ using\ the\ ADCSwitchingTest\ example\ from\ this\ library}}
\DoxyCodeLine{00148\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00149\ uint8\_t\ checkAndWaitForReferenceAndChannelToSwitch(uint8\_t\ aADCChannelNumber,\ uint8\_t\ aReference)\ \{}
\DoxyCodeLine{00150\ \ \ \ \ uint8\_t\ tOldADMUX\ =\ ADMUX;}
\DoxyCodeLine{00151\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00152\ \textcolor{comment}{\ \ \ \ \ *\ Must\ wait\ >=\ 7\ us\ if\ reference\ has\ to\ be\ switched\ from\ 1.1\ volt/INTERNAL\ to\ VCC/DEFAULT\ (seen\ on\ oscilloscope)}}
\DoxyCodeLine{00153\ \textcolor{comment}{\ \ \ \ \ *\ This\ is\ done\ after\ the\ 2\ ADC\ clock\ cycles\ required\ for\ Sample\ \&\ Hold\ :-\/)}}
\DoxyCodeLine{00154\ \textcolor{comment}{\ \ \ \ \ *}}
\DoxyCodeLine{00155\ \textcolor{comment}{\ \ \ \ \ *\ Must\ wait\ >=\ 7600\ us\ for\ Nano\ board\ \ >=\ 6200\ for\ Uno\ board\ if\ reference\ has\ to\ be\ switched\ from\ VCC/DEFAULT\ to\ 1.1\ volt/INTERNAL}}
\DoxyCodeLine{00156\ \textcolor{comment}{\ \ \ \ \ *\ Must\ wait\ >=\ 200\ us\ if\ channel\ has\ to\ be\ switched\ to\ 1.1\ volt\ internal\ channel\ if\ S\&H\ was\ at\ 5\ Volt}}
\DoxyCodeLine{00157\ \textcolor{comment}{\ \ \ \ \ */}}
\DoxyCodeLine{00158\ \ \ \ \ uint8\_t\ tNewReference\ =\ (aReference\ <<\ SHIFT\_VALUE\_FOR\_REFERENCE);}
\DoxyCodeLine{00159\ \ \ \ \ ADMUX\ =\ aADCChannelNumber\ |\ tNewReference;}
\DoxyCodeLine{00160\ \textcolor{preprocessor}{\#if\ defined(INTERNAL2V56)}}
\DoxyCodeLine{00161\ \ \ \ \ \textcolor{keywordflow}{if}\ ((tOldADMUX\ \&\ MASK\_FOR\_ADC\_REFERENCE)\ !=\ tNewReference\ \&\&\ (aReference\ ==\ INTERNAL\ ||\ aReference\ ==\ INTERNAL2V56))\ \{}
\DoxyCodeLine{00162\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00163\ \ \ \ \ \textcolor{keywordflow}{if}\ ((tOldADMUX\ \&\ MASK\_FOR\_ADC\_REFERENCE)\ !=\ tNewReference\ \&\&\ aReference\ ==\ INTERNAL)\ \{}
\DoxyCodeLine{00164\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00165\ \textcolor{preprocessor}{\#if\ defined(LOCAL\_DEBUG)}}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \ \ Serial.println(F(\textcolor{stringliteral}{"{}Switch\ from\ DEFAULT\ to\ INTERNAL"{}}));}
\DoxyCodeLine{00167\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00169\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ *\ Switch\ reference\ from\ DEFAULT\ to\ INTERNAL}}
\DoxyCodeLine{00170\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ */}}
\DoxyCodeLine{00171\ \ \ \ \ \ \ \ \ delayMicroseconds(8000);\ \textcolor{comment}{//\ experimental\ value\ is\ >=\ 7600\ us\ for\ Nano\ board\ and\ 6200\ for\ Uno\ board}}
\DoxyCodeLine{00172\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ ((tOldADMUX\ \&\ ADC\_CHANNEL\_MUX\_MASK)\ !=\ aADCChannelNumber)\ \{}
\DoxyCodeLine{00173\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (aADCChannelNumber\ ==\ ADC\_1\_1\_VOLT\_CHANNEL\_MUX)\ \{}
\DoxyCodeLine{00174\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00175\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ *\ Internal\ 1.1\ Volt\ channel\ requires\ \ <=\ 200\ us\ for\ Nano\ board}}
\DoxyCodeLine{00176\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ */}}
\DoxyCodeLine{00177\ \ \ \ \ \ \ \ \ \ \ \ \ delayMicroseconds(350);\ \textcolor{comment}{//\ 350\ was\ ok\ and\ 300\ was\ too\ less\ for\ UltimateBatteryTester\ -\/\ result\ was\ 226\ instead\ of\ 225}}
\DoxyCodeLine{00178\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00179\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00180\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ *\ 100\ kOhm\ requires\ <\ 100\ us,\ 1\ MOhm\ requires\ 120\ us\ S\&H\ switching\ time}}
\DoxyCodeLine{00181\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ */}}
\DoxyCodeLine{00182\ \ \ \ \ \ \ \ \ \ \ \ \ delayMicroseconds(120);\ \textcolor{comment}{//\ experimental\ value\ is\ <=\ 1100\ us\ for\ Nano\ board}}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00184\ \ \ \ \ \}}
\DoxyCodeLine{00185\ \ \ \ \ \textcolor{keywordflow}{return}\ tOldADMUX;}
\DoxyCodeLine{00186\ \}}
\DoxyCodeLine{00187\ }
\DoxyCodeLine{00188\ \textcolor{comment}{/*}}
\DoxyCodeLine{00189\ \textcolor{comment}{\ *\ Oversample\ and\ multiple\ samples\ only\ makes\ sense\ if\ you\ expect\ a\ noisy\ input\ signal}}
\DoxyCodeLine{00190\ \textcolor{comment}{\ *\ It\ does\ NOT\ increase\ the\ precision\ of\ the\ measurement,\ since\ the\ ADC\ has\ insignificant\ noise}}
\DoxyCodeLine{00191\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00192\ uint16\_t\ readADCChannelWithOversample(uint8\_t\ aADCChannelNumber,\ uint8\_t\ aOversampleExponent)\ \{}
\DoxyCodeLine{00193\ \ \ \ \ \textcolor{keywordflow}{return}\ readADCChannelWithReferenceOversample(aADCChannelNumber,\ DEFAULT,\ aOversampleExponent);}
\DoxyCodeLine{00194\ \}}
\DoxyCodeLine{00195\ }
\DoxyCodeLine{00196\ \textcolor{comment}{/*}}
\DoxyCodeLine{00197\ \textcolor{comment}{\ *\ Conversion\ time\ is\ defined\ as\ 0.104\ milliseconds\ by\ ADC\_PRESCALE\ in\ ADCUtils.h.}}
\DoxyCodeLine{00198\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00199\ uint16\_t\ readADCChannelWithReferenceOversample(uint8\_t\ aADCChannelNumber,\ uint8\_t\ aReference,\ uint8\_t\ aOversampleExponent)\ \{}
\DoxyCodeLine{00200\ \ \ \ \ uint16\_t\ tSumValue\ =\ 0;}
\DoxyCodeLine{00201\ \ \ \ \ ADMUX\ =\ aADCChannelNumber\ |\ (aReference\ <<\ SHIFT\_VALUE\_FOR\_REFERENCE);}
\DoxyCodeLine{00202\ }
\DoxyCodeLine{00203\ \ \ \ \ ADCSRB\ =\ 0;\ \textcolor{comment}{//\ Free\ running\ mode.\ Only\ active\ if\ ADATE\ is\ set\ to\ 1.}}
\DoxyCodeLine{00204\ \ \ \ \ \textcolor{comment}{//\ ADSC-\/StartConversion\ ADATE-\/AutoTriggerEnable\ ADIF-\/Reset\ Interrupt\ Flag}}
\DoxyCodeLine{00205\ \ \ \ \ ADCSRA\ =\ (\_BV(ADEN)\ |\ \_BV(ADSC)\ |\ \_BV(ADATE)\ |\ \_BV(ADIF)\ |\ ADC\_PRESCALE);}
\DoxyCodeLine{00206\ }
\DoxyCodeLine{00207\ \ \ \ \ uint8\_t\ tCount\ =\ \_BV(aOversampleExponent);}
\DoxyCodeLine{00208\ \ \ \ \ \textcolor{keywordflow}{for}\ (uint8\_t\ i\ =\ 0;\ i\ <\ tCount;\ i++)\ \{}
\DoxyCodeLine{00209\ \ \ \ \ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00210\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ *\ wait\ for\ free\ running\ conversion\ to\ finish.}}
\DoxyCodeLine{00211\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ *\ Do\ not\ wait\ for\ ADSC\ here,\ since\ ADSC\ is\ only\ low\ for\ 1\ ADC\ Clock\ cycle\ on\ free\ running\ conversion.}}
\DoxyCodeLine{00212\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ */}}
\DoxyCodeLine{00213\ \ \ \ \ \ \ \ \ loop\_until\_bit\_is\_set(ADCSRA,\ ADIF);}
\DoxyCodeLine{00214\ }
\DoxyCodeLine{00215\ \ \ \ \ \ \ \ \ ADCSRA\ |=\ \_BV(ADIF);\ \textcolor{comment}{//\ clear\ bit\ to\ enable\ recognizing\ next\ conversion\ has\ finished}}
\DoxyCodeLine{00216\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Add\ value}}
\DoxyCodeLine{00217\ \ \ \ \ \ \ \ \ tSumValue\ +=\ ADCL\ |\ (ADCH\ <<\ 8);\ \textcolor{comment}{//\ using\ WordUnionForADCUtils\ does\ not\ save\ space\ here}}
\DoxyCodeLine{00218\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ tSumValue\ +=\ (ADCH\ <<\ 8)\ |\ ADCL;\ //\ this\ does\ NOT\ work!}}
\DoxyCodeLine{00219\ \ \ \ \ \}}
\DoxyCodeLine{00220\ \ \ \ \ ADCSRA\ \&=\ \string~\_BV(ADATE);\ \textcolor{comment}{//\ Disable\ auto-\/triggering\ (free\ running\ mode)}}
\DoxyCodeLine{00221\ \ \ \ \ \textcolor{comment}{//\ return\ rounded\ value}}
\DoxyCodeLine{00222\ \ \ \ \ \textcolor{keywordflow}{return}\ ((tSumValue\ +\ (tCount\ >>\ 1))\ >>\ aOversampleExponent);}
\DoxyCodeLine{00223\ \}}
\DoxyCodeLine{00224\ }
\DoxyCodeLine{00225\ \textcolor{comment}{/*}}
\DoxyCodeLine{00226\ \textcolor{comment}{\ *\ Use\ ADC\_PRESCALE32\ which\ gives\ 26\ us\ conversion\ time\ and\ good\ linearity\ for\ 16\ MHz\ Arduino}}
\DoxyCodeLine{00227\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00228\ uint16\_t\ readADCChannelWithReferenceOversampleFast(uint8\_t\ aADCChannelNumber,\ uint8\_t\ aReference,\ uint8\_t\ aOversampleExponent)\ \{}
\DoxyCodeLine{00229\ \ \ \ \ uint16\_t\ tSumValue\ =\ 0;}
\DoxyCodeLine{00230\ \ \ \ \ ADMUX\ =\ aADCChannelNumber\ |\ (aReference\ <<\ SHIFT\_VALUE\_FOR\_REFERENCE);}
\DoxyCodeLine{00231\ }
\DoxyCodeLine{00232\ \ \ \ \ ADCSRB\ =\ 0;\ \textcolor{comment}{//\ Free\ running\ mode.\ Only\ active\ if\ ADATE\ is\ set\ to\ 1.}}
\DoxyCodeLine{00233\ \ \ \ \ \textcolor{comment}{//\ ADSC-\/StartConversion\ ADATE-\/AutoTriggerEnable\ ADIF-\/Reset\ Interrupt\ Flag}}
\DoxyCodeLine{00234\ \ \ \ \ ADCSRA\ =\ (\_BV(ADEN)\ |\ \_BV(ADSC)\ |\ \_BV(ADATE)\ |\ \_BV(ADIF)\ |\ ADC\_PRESCALE32);}
\DoxyCodeLine{00235\ }
\DoxyCodeLine{00236\ \ \ \ \ uint8\_t\ tCount\ =\ \_BV(aOversampleExponent);}
\DoxyCodeLine{00237\ \ \ \ \ \textcolor{keywordflow}{for}\ (uint8\_t\ i\ =\ 0;\ i\ <\ tCount;\ i++)\ \{}
\DoxyCodeLine{00238\ \ \ \ \ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00239\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ *\ wait\ for\ free\ running\ conversion\ to\ finish.}}
\DoxyCodeLine{00240\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ *\ Do\ not\ wait\ for\ ADSC\ here,\ since\ ADSC\ is\ only\ low\ for\ 1\ ADC\ Clock\ cycle\ on\ free\ running\ conversion.}}
\DoxyCodeLine{00241\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ */}}
\DoxyCodeLine{00242\ \ \ \ \ \ \ \ \ loop\_until\_bit\_is\_set(ADCSRA,\ ADIF);}
\DoxyCodeLine{00243\ }
\DoxyCodeLine{00244\ \ \ \ \ \ \ \ \ ADCSRA\ |=\ \_BV(ADIF);\ \textcolor{comment}{//\ clear\ bit\ to\ enable\ recognizing\ next\ conversion\ has\ finished}}
\DoxyCodeLine{00245\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Add\ value}}
\DoxyCodeLine{00246\ \ \ \ \ \ \ \ \ tSumValue\ +=\ ADCL\ |\ (ADCH\ <<\ 8);\ \textcolor{comment}{//\ using\ WordUnionForADCUtils\ does\ not\ save\ space\ here}}
\DoxyCodeLine{00247\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ tSumValue\ +=\ (ADCH\ <<\ 8)\ |\ ADCL;\ //\ this\ does\ NOT\ work!}}
\DoxyCodeLine{00248\ \ \ \ \ \}}
\DoxyCodeLine{00249\ \ \ \ \ ADCSRA\ \&=\ \string~\_BV(ADATE);\ \textcolor{comment}{//\ Disable\ auto-\/triggering\ (free\ running\ mode)}}
\DoxyCodeLine{00250\ \ \ \ \ \textcolor{keywordflow}{return}\ ((tSumValue\ +\ (tCount\ >>\ 1))\ >>\ aOversampleExponent);}
\DoxyCodeLine{00251\ \}}
\DoxyCodeLine{00252\ }
\DoxyCodeLine{00253\ \textcolor{comment}{/*}}
\DoxyCodeLine{00254\ \textcolor{comment}{\ *\ Returns\ sum\ of\ all\ sample\ values}}
\DoxyCodeLine{00255\ \textcolor{comment}{\ *\ Conversion\ time\ is\ defined\ as\ 0.104\ milliseconds\ for\ 16\ MHz\ Arduino\ by\ ADC\_PRESCALE\ (=ADC\_PRESCALE128)\ in\ ADCUtils.h.}}
\DoxyCodeLine{00256\ \textcolor{comment}{\ *\ @\ param\ aNumberOfSamples\ If\ >\ 64\ an\ overflow\ may\ occur.}}
\DoxyCodeLine{00257\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00258\ uint16\_t\ readADCChannelMultiSamplesWithReference(uint8\_t\ aADCChannelNumber,\ uint8\_t\ aReference,\ uint8\_t\ aNumberOfSamples)\ \{}
\DoxyCodeLine{00259\ \ \ \ \ uint16\_t\ tSumValue\ =\ 0;}
\DoxyCodeLine{00260\ \ \ \ \ ADMUX\ =\ aADCChannelNumber\ |\ (aReference\ <<\ SHIFT\_VALUE\_FOR\_REFERENCE);}
\DoxyCodeLine{00261\ }
\DoxyCodeLine{00262\ \ \ \ \ ADCSRB\ =\ 0;\ \textcolor{comment}{//\ Free\ running\ mode.\ Only\ active\ if\ ADATE\ is\ set\ to\ 1.}}
\DoxyCodeLine{00263\ \ \ \ \ \textcolor{comment}{//\ ADSC-\/StartConversion\ ADATE-\/AutoTriggerEnable\ ADIF-\/Reset\ Interrupt\ Flag}}
\DoxyCodeLine{00264\ \ \ \ \ ADCSRA\ =\ (\_BV(ADEN)\ |\ \_BV(ADSC)\ |\ \_BV(ADATE)\ |\ \_BV(ADIF)\ |\ ADC\_PRESCALE);}
\DoxyCodeLine{00265\ }
\DoxyCodeLine{00266\ \ \ \ \ \textcolor{keywordflow}{for}\ (uint8\_t\ i\ =\ 0;\ i\ <\ aNumberOfSamples;\ i++)\ \{}
\DoxyCodeLine{00267\ \ \ \ \ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00268\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ *\ wait\ for\ free\ running\ conversion\ to\ finish.}}
\DoxyCodeLine{00269\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ *\ Do\ not\ wait\ for\ ADSC\ here,\ since\ ADSC\ is\ only\ low\ for\ 1\ ADC\ Clock\ cycle\ on\ free\ running\ conversion.}}
\DoxyCodeLine{00270\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ */}}
\DoxyCodeLine{00271\ \ \ \ \ \ \ \ \ loop\_until\_bit\_is\_set(ADCSRA,\ ADIF);}
\DoxyCodeLine{00272\ }
\DoxyCodeLine{00273\ \ \ \ \ \ \ \ \ ADCSRA\ |=\ \_BV(ADIF);\ \textcolor{comment}{//\ clear\ bit\ to\ enable\ recognizing\ next\ conversion\ has\ finished}}
\DoxyCodeLine{00274\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Add\ value}}
\DoxyCodeLine{00275\ \ \ \ \ \ \ \ \ tSumValue\ +=\ ADCL\ |\ (ADCH\ <<\ 8);\ \textcolor{comment}{//\ using\ WordUnionForADCUtils\ does\ not\ save\ space\ here}}
\DoxyCodeLine{00276\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ tSumValue\ +=\ (ADCH\ <<\ 8)\ |\ ADCL;\ //\ this\ does\ NOT\ work!}}
\DoxyCodeLine{00277\ \ \ \ \ \}}
\DoxyCodeLine{00278\ \ \ \ \ ADCSRA\ \&=\ \string~\_BV(ADATE);\ \textcolor{comment}{//\ Disable\ auto-\/triggering\ (free\ running\ mode)}}
\DoxyCodeLine{00279\ \ \ \ \ \textcolor{keywordflow}{return}\ tSumValue;}
\DoxyCodeLine{00280\ \}}
\DoxyCodeLine{00281\ }
\DoxyCodeLine{00282\ \textcolor{comment}{/*}}
\DoxyCodeLine{00283\ \textcolor{comment}{\ *\ Returns\ sum\ of\ all\ sample\ values}}
\DoxyCodeLine{00284\ \textcolor{comment}{\ *\ Conversion\ time\ is\ defined\ as\ 0.104\ milliseconds\ for\ 16\ MHz\ Arduino\ for\ ADC\_PRESCALE128\ in\ ADCUtils.h.}}
\DoxyCodeLine{00285\ \textcolor{comment}{\ *\ @\ param\ aPrescale\ can\ be\ one\ of\ ADC\_PRESCALE2,\ ADC\_PRESCALE4,\ 8,\ 16,\ 32,\ 64,\ 128.}}
\DoxyCodeLine{00286\ \textcolor{comment}{\ *\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ADC\_PRESCALE32\ is\ recommended\ for\ excellent\ linearity\ and\ fast\ readout\ of\ 26\ microseconds}}
\DoxyCodeLine{00287\ \textcolor{comment}{\ *\ @\ param\ aNumberOfSamples\ If\ >\ 16k\ an\ overflow\ may\ occur.}}
\DoxyCodeLine{00288\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00289\ uint32\_t\ readADCChannelMultiSamplesWithReferenceAndPrescaler(uint8\_t\ aADCChannelNumber,\ uint8\_t\ aReference,\ uint8\_t\ aPrescale,}
\DoxyCodeLine{00290\ \ \ \ \ \ \ \ \ uint16\_t\ aNumberOfSamples)\ \{}
\DoxyCodeLine{00291\ \ \ \ \ uint32\_t\ tSumValue\ =\ 0;}
\DoxyCodeLine{00292\ \ \ \ \ ADMUX\ =\ aADCChannelNumber\ |\ (aReference\ <<\ SHIFT\_VALUE\_FOR\_REFERENCE);}
\DoxyCodeLine{00293\ }
\DoxyCodeLine{00294\ \ \ \ \ ADCSRB\ =\ 0;\ \textcolor{comment}{//\ Free\ running\ mode.\ Only\ active\ if\ ADATE\ is\ set\ to\ 1.}}
\DoxyCodeLine{00295\ \ \ \ \ \textcolor{comment}{//\ ADSC-\/StartConversion\ ADATE-\/AutoTriggerEnable\ ADIF-\/Reset\ Interrupt\ Flag}}
\DoxyCodeLine{00296\ \ \ \ \ ADCSRA\ =\ (\_BV(ADEN)\ |\ \_BV(ADSC)\ |\ \_BV(ADATE)\ |\ \_BV(ADIF)\ |\ aPrescale);}
\DoxyCodeLine{00297\ }
\DoxyCodeLine{00298\ \ \ \ \ \textcolor{keywordflow}{for}\ (uint16\_t\ i\ =\ 0;\ i\ <\ aNumberOfSamples;\ i++)\ \{}
\DoxyCodeLine{00299\ \ \ \ \ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00300\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ *\ wait\ for\ free\ running\ conversion\ to\ finish.}}
\DoxyCodeLine{00301\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ *\ Do\ not\ wait\ for\ ADSC\ here,\ since\ ADSC\ is\ only\ low\ for\ 1\ ADC\ Clock\ cycle\ on\ free\ running\ conversion.}}
\DoxyCodeLine{00302\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ */}}
\DoxyCodeLine{00303\ \ \ \ \ \ \ \ \ loop\_until\_bit\_is\_set(ADCSRA,\ ADIF);}
\DoxyCodeLine{00304\ }
\DoxyCodeLine{00305\ \ \ \ \ \ \ \ \ ADCSRA\ |=\ \_BV(ADIF);\ \textcolor{comment}{//\ clear\ bit\ to\ enable\ recognizing\ next\ conversion\ has\ finished}}
\DoxyCodeLine{00306\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Add\ value}}
\DoxyCodeLine{00307\ \ \ \ \ \ \ \ \ tSumValue\ +=\ ADCL\ |\ (ADCH\ <<\ 8);\ \textcolor{comment}{//\ using\ WordUnionForADCUtils\ does\ not\ save\ space\ here}}
\DoxyCodeLine{00308\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ tSumValue\ +=\ (ADCH\ <<\ 8)\ |\ ADCL;\ //\ this\ does\ NOT\ work!}}
\DoxyCodeLine{00309\ \ \ \ \ \}}
\DoxyCodeLine{00310\ \ \ \ \ ADCSRA\ \&=\ \string~\_BV(ADATE);\ \textcolor{comment}{//\ Disable\ auto-\/triggering\ (free\ running\ mode)}}
\DoxyCodeLine{00311\ \ \ \ \ \textcolor{keywordflow}{return}\ tSumValue;}
\DoxyCodeLine{00312\ \}}
\DoxyCodeLine{00313\ }
\DoxyCodeLine{00314\ \textcolor{comment}{/*}}
\DoxyCodeLine{00315\ \textcolor{comment}{\ *\ Returns\ sum\ of\ all\ sample\ values}}
\DoxyCodeLine{00316\ \textcolor{comment}{\ *\ Assumes,\ that\ channel\ and\ reference\ are\ still\ set\ to\ the\ right\ values}}
\DoxyCodeLine{00317\ \textcolor{comment}{\ *\ @\ param\ aNumberOfSamples\ If\ >\ 16k\ an\ overflow\ may\ occur.}}
\DoxyCodeLine{00318\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00319\ uint32\_t\ readADCChannelMultiSamples(uint8\_t\ aPrescale,\ uint16\_t\ aNumberOfSamples)\ \{}
\DoxyCodeLine{00320\ \ \ \ \ uint32\_t\ tSumValue\ =\ 0;}
\DoxyCodeLine{00321\ }
\DoxyCodeLine{00322\ \ \ \ \ ADCSRB\ =\ 0;\ \textcolor{comment}{//\ Free\ running\ mode.\ Only\ active\ if\ ADATE\ is\ set\ to\ 1.}}
\DoxyCodeLine{00323\ \ \ \ \ \textcolor{comment}{//\ ADSC-\/StartConversion\ ADATE-\/AutoTriggerEnable\ ADIF-\/Reset\ Interrupt\ Flag}}
\DoxyCodeLine{00324\ \ \ \ \ ADCSRA\ =\ (\_BV(ADEN)\ |\ \_BV(ADSC)\ |\ \_BV(ADATE)\ |\ \_BV(ADIF)\ |\ aPrescale);}
\DoxyCodeLine{00325\ }
\DoxyCodeLine{00326\ \ \ \ \ \textcolor{keywordflow}{for}\ (uint16\_t\ i\ =\ 0;\ i\ <\ aNumberOfSamples;\ i++)\ \{}
\DoxyCodeLine{00327\ \ \ \ \ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00328\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ *\ wait\ for\ free\ running\ conversion\ to\ finish.}}
\DoxyCodeLine{00329\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ *\ Do\ not\ wait\ for\ ADSC\ here,\ since\ ADSC\ is\ only\ low\ for\ 1\ ADC\ Clock\ cycle\ on\ free\ running\ conversion.}}
\DoxyCodeLine{00330\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ */}}
\DoxyCodeLine{00331\ \ \ \ \ \ \ \ \ loop\_until\_bit\_is\_set(ADCSRA,\ ADIF);}
\DoxyCodeLine{00332\ }
\DoxyCodeLine{00333\ \ \ \ \ \ \ \ \ ADCSRA\ |=\ \_BV(ADIF);\ \textcolor{comment}{//\ clear\ bit\ to\ enable\ recognizing\ next\ conversion\ has\ finished}}
\DoxyCodeLine{00334\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Add\ value}}
\DoxyCodeLine{00335\ \ \ \ \ \ \ \ \ tSumValue\ +=\ ADCL\ |\ (ADCH\ <<\ 8);\ \textcolor{comment}{//\ using\ WordUnionForADCUtils\ does\ not\ save\ space\ here}}
\DoxyCodeLine{00336\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ tSumValue\ +=\ (ADCH\ <<\ 8)\ |\ ADCL;\ //\ this\ does\ NOT\ work!}}
\DoxyCodeLine{00337\ \ \ \ \ \}}
\DoxyCodeLine{00338\ \ \ \ \ ADCSRA\ \&=\ \string~\_BV(ADATE);\ \textcolor{comment}{//\ Disable\ auto-\/triggering\ (free\ running\ mode)}}
\DoxyCodeLine{00339\ \ \ \ \ \textcolor{keywordflow}{return}\ tSumValue;}
\DoxyCodeLine{00340\ \}}
\DoxyCodeLine{00341\ \textcolor{comment}{/*}}
\DoxyCodeLine{00342\ \textcolor{comment}{\ *\ use\ ADC\_PRESCALE32\ which\ gives\ 26\ us\ conversion\ time\ and\ good\ linearity}}
\DoxyCodeLine{00343\ \textcolor{comment}{\ *\ @return\ the\ maximum\ value\ of\ aNumberOfSamples\ samples.}}
\DoxyCodeLine{00344\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00345\ uint16\_t\ readADCChannelWithReferenceMax(uint8\_t\ aADCChannelNumber,\ uint8\_t\ aReference,\ uint16\_t\ aNumberOfSamples)\ \{}
\DoxyCodeLine{00346\ \ \ \ \ uint16\_t\ tADCValue\ =\ 0;}
\DoxyCodeLine{00347\ \ \ \ \ uint16\_t\ tMaximum\ =\ 0;}
\DoxyCodeLine{00348\ \ \ \ \ ADMUX\ =\ aADCChannelNumber\ |\ (aReference\ <<\ SHIFT\_VALUE\_FOR\_REFERENCE);}
\DoxyCodeLine{00349\ }
\DoxyCodeLine{00350\ \ \ \ \ ADCSRB\ =\ 0;\ \textcolor{comment}{//\ Free\ running\ mode.\ Only\ active\ if\ ADATE\ is\ set\ to\ 1.}}
\DoxyCodeLine{00351\ \ \ \ \ \textcolor{comment}{//\ ADSC-\/StartConversion\ ADATE-\/AutoTriggerEnable\ ADIF-\/Reset\ Interrupt\ Flag}}
\DoxyCodeLine{00352\ \ \ \ \ ADCSRA\ =\ (\_BV(ADEN)\ |\ \_BV(ADSC)\ |\ \_BV(ADATE)\ |\ \_BV(ADIF)\ |\ ADC\_PRESCALE32);}
\DoxyCodeLine{00353\ }
\DoxyCodeLine{00354\ \ \ \ \ \textcolor{keywordflow}{for}\ (uint16\_t\ i\ =\ 0;\ i\ <\ aNumberOfSamples;\ i++)\ \{}
\DoxyCodeLine{00355\ \ \ \ \ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00356\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ *\ wait\ for\ free\ running\ conversion\ to\ finish.}}
\DoxyCodeLine{00357\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ *\ Do\ not\ wait\ for\ ADSC\ here,\ since\ ADSC\ is\ only\ low\ for\ 1\ ADC\ Clock\ cycle\ on\ free\ running\ conversion.}}
\DoxyCodeLine{00358\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ */}}
\DoxyCodeLine{00359\ \ \ \ \ \ \ \ \ loop\_until\_bit\_is\_set(ADCSRA,\ ADIF);}
\DoxyCodeLine{00360\ }
\DoxyCodeLine{00361\ \ \ \ \ \ \ \ \ ADCSRA\ |=\ \_BV(ADIF);\ \textcolor{comment}{//\ clear\ bit\ to\ enable\ recognizing\ next\ conversion\ has\ finished}}
\DoxyCodeLine{00362\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ check\ value}}
\DoxyCodeLine{00363\ \ \ \ \ \ \ \ \ tADCValue\ =\ ADCL\ |\ (ADCH\ <<\ 8);}
\DoxyCodeLine{00364\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (tADCValue\ >\ tMaximum)\ \{}
\DoxyCodeLine{00365\ \ \ \ \ \ \ \ \ \ \ \ \ tMaximum\ =\ tADCValue;}
\DoxyCodeLine{00366\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00367\ \ \ \ \ \}}
\DoxyCodeLine{00368\ \ \ \ \ ADCSRA\ \&=\ \string~\_BV(ADATE);\ \textcolor{comment}{//\ Disable\ auto-\/triggering\ (free\ running\ mode)}}
\DoxyCodeLine{00369\ \ \ \ \ \textcolor{keywordflow}{return}\ tMaximum;}
\DoxyCodeLine{00370\ \}}
\DoxyCodeLine{00371\ }
\DoxyCodeLine{00372\ \textcolor{comment}{/*}}
\DoxyCodeLine{00373\ \textcolor{comment}{\ *\ use\ ADC\_PRESCALE32\ which\ gives\ 26\ us\ conversion\ time\ and\ good\ linearity}}
\DoxyCodeLine{00374\ \textcolor{comment}{\ *\ @return\ the\ maximum\ value\ during\ aMicrosecondsToAquire\ measurement.}}
\DoxyCodeLine{00375\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00376\ uint16\_t\ readADCChannelWithReferenceMaxMicros(uint8\_t\ aADCChannelNumber,\ uint8\_t\ aReference,\ uint16\_t\ aMicrosecondsToAquire)\ \{}
\DoxyCodeLine{00377\ \ \ \ \ uint16\_t\ tNumberOfSamples\ =\ aMicrosecondsToAquire\ /\ 26;}
\DoxyCodeLine{00378\ \ \ \ \ \textcolor{keywordflow}{return}\ readADCChannelWithReferenceMax(aADCChannelNumber,\ aReference,\ tNumberOfSamples);}
\DoxyCodeLine{00379\ \}}
\DoxyCodeLine{00380\ }
\DoxyCodeLine{00381\ \textcolor{comment}{/*}}
\DoxyCodeLine{00382\ \textcolor{comment}{\ *\ aMaxRetries\ =\ 255\ -\/>\ try\ forever}}
\DoxyCodeLine{00383\ \textcolor{comment}{\ *\ @return\ (tMax\ +\ tMin)\ /\ 2}}
\DoxyCodeLine{00384\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00385\ uint16\_t\ readUntil4ConsecutiveValuesAreEqual(uint8\_t\ aADCChannelNumber,\ uint8\_t\ aReference,\ uint8\_t\ aDelay,}
\DoxyCodeLine{00386\ \ \ \ \ \ \ \ \ uint8\_t\ aAllowedDifference,\ uint8\_t\ aMaxRetries)\ \{}
\DoxyCodeLine{00387\ \ \ \ \ \textcolor{keywordtype}{int}\ tValues[4];\ \textcolor{comment}{//\ last\ value\ is\ in\ tValues[3]}}
\DoxyCodeLine{00388\ \ \ \ \ \textcolor{keywordtype}{int}\ tMin;}
\DoxyCodeLine{00389\ \ \ \ \ \textcolor{keywordtype}{int}\ tMax;}
\DoxyCodeLine{00390\ }
\DoxyCodeLine{00391\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00392\ \textcolor{comment}{\ \ \ \ \ *\ Initialize\ first\ 4\ values\ before\ checking}}
\DoxyCodeLine{00393\ \textcolor{comment}{\ \ \ \ \ */}}
\DoxyCodeLine{00394\ \ \ \ \ tValues[0]\ =\ readADCChannelWithReference(aADCChannelNumber,\ aReference);}
\DoxyCodeLine{00395\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 1;\ i\ <\ 4;\ ++i)\ \{}
\DoxyCodeLine{00396\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (aDelay\ !=\ 0)\ \{}
\DoxyCodeLine{00397\ \ \ \ \ \ \ \ \ \ \ \ \ delay(aDelay);\ \textcolor{comment}{//\ Minimum\ is\ only\ 3\ delays!}}
\DoxyCodeLine{00398\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00399\ \ \ \ \ \ \ \ \ tValues[i]\ =\ readADCChannelWithReference(aADCChannelNumber,\ aReference);}
\DoxyCodeLine{00400\ \ \ \ \ \}}
\DoxyCodeLine{00401\ }
\DoxyCodeLine{00402\ \ \ \ \ \textcolor{keywordflow}{do}\ \{}
\DoxyCodeLine{00403\ \ \ \ \ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00404\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ *\ Get\ min\ and\ max\ of\ the\ last\ 4\ values}}
\DoxyCodeLine{00405\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ */}}
\DoxyCodeLine{00406\ \ \ \ \ \ \ \ \ tMin\ =\ 1024;}
\DoxyCodeLine{00407\ \ \ \ \ \ \ \ \ tMax\ =\ 0;}
\DoxyCodeLine{00408\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (uint\_fast8\_t\ i\ =\ 0;\ i\ <\ 4;\ ++i)\ \{}
\DoxyCodeLine{00409\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (tValues[i]\ <\ tMin)\ \{}
\DoxyCodeLine{00410\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tMin\ =\ tValues[i];}
\DoxyCodeLine{00411\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00412\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (tValues[i]\ >\ tMax)\ \{}
\DoxyCodeLine{00413\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tMax\ =\ tValues[i];}
\DoxyCodeLine{00414\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00415\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00416\ \ \ \ \ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00417\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ *\ check\ for\ terminating\ condition}}
\DoxyCodeLine{00418\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ */}}
\DoxyCodeLine{00419\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((tMax\ -\/\ tMin)\ <=\ aAllowedDifference)\ \{}
\DoxyCodeLine{00420\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00421\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00422\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00423\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ *\ Get\ next\ value}}
\DoxyCodeLine{00424\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ */}}
\DoxyCodeLine{00425\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ Serial.print("{}Difference="{});}}
\DoxyCodeLine{00426\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ Serial.println(tMax\ -\/\ tMin);}}
\DoxyCodeLine{00427\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Move\ values\ to\ front}}
\DoxyCodeLine{00428\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ 3;\ ++i)\ \{}
\DoxyCodeLine{00429\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tValues[i]\ =\ tValues[i\ +\ 1];}
\DoxyCodeLine{00430\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00431\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ and\ wait\ before\ getting\ next\ value}}
\DoxyCodeLine{00432\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (aDelay\ !=\ 0)\ \{}
\DoxyCodeLine{00433\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ delay(aDelay);}
\DoxyCodeLine{00434\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00435\ \ \ \ \ \ \ \ \ \ \ \ \ tValues[3]\ =\ readADCChannelWithReference(aADCChannelNumber,\ aReference);}
\DoxyCodeLine{00436\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00437\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (aMaxRetries\ !=\ 255)\ \{}
\DoxyCodeLine{00438\ \ \ \ \ \ \ \ \ \ \ \ \ aMaxRetries-\/-\/;}
\DoxyCodeLine{00439\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00440\ \ \ \ \ \}\ \textcolor{keywordflow}{while}\ (aMaxRetries\ >\ 0);}
\DoxyCodeLine{00441\ }
\DoxyCodeLine{00442\ \textcolor{preprocessor}{\#if\ defined(LOCAL\_DEBUG)}}
\DoxyCodeLine{00443\ \ \ \ \ \textcolor{keywordflow}{if}(aMaxRetries\ ==\ 0)\ \{}
\DoxyCodeLine{00444\ \ \ \ \ \ \ \ \ Serial.print(F(\textcolor{stringliteral}{"{}No\ 4\ equal\ values\ for\ difference\ "{}}));}
\DoxyCodeLine{00445\ \ \ \ \ \ \ \ \ Serial.print(aAllowedDifference);}
\DoxyCodeLine{00446\ \ \ \ \ \ \ \ \ Serial.print(F(\textcolor{stringliteral}{"{}\ found\ "{}}));}
\DoxyCodeLine{00447\ \ \ \ \ \ \ \ \ Serial.print(tValues[0]);}
\DoxyCodeLine{00448\ \ \ \ \ \ \ \ \ Serial.print(\textcolor{charliteral}{'\ '});}
\DoxyCodeLine{00449\ \ \ \ \ \ \ \ \ Serial.print(tValues[1]);}
\DoxyCodeLine{00450\ \ \ \ \ \ \ \ \ Serial.print(\textcolor{charliteral}{'\ '});}
\DoxyCodeLine{00451\ \ \ \ \ \ \ \ \ Serial.print(tValues[2]);}
\DoxyCodeLine{00452\ \ \ \ \ \ \ \ \ Serial.print(\textcolor{charliteral}{'\ '});}
\DoxyCodeLine{00453\ \ \ \ \ \ \ \ \ Serial.println(tValues[3]);}
\DoxyCodeLine{00454\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00455\ \ \ \ \ \ \ \ \ Serial.print(aMaxRetries);}
\DoxyCodeLine{00456\ \ \ \ \ \ \ \ \ Serial.println(F(\textcolor{stringliteral}{"{}\ retries\ left"{}}));}
\DoxyCodeLine{00457\ \ \ \ \ \}}
\DoxyCodeLine{00458\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00459\ }
\DoxyCodeLine{00460\ \ \ \ \ \textcolor{keywordflow}{return}\ (tMax\ +\ tMin)\ /\ 2;}
\DoxyCodeLine{00461\ \}}
\DoxyCodeLine{00462\ }
\DoxyCodeLine{00463\ \textcolor{comment}{/*}}
\DoxyCodeLine{00464\ \textcolor{comment}{\ *\ !!!\ Function\ without\ handling\ of\ switched\ reference\ and\ channel.!!!}}
\DoxyCodeLine{00465\ \textcolor{comment}{\ *\ Use\ it\ ONLY\ if\ you\ only\ call\ getVCCVoltageSimple()\ or\ getVCCVoltageMillivoltSimple()\ in\ your\ program.}}
\DoxyCodeLine{00466\ \textcolor{comment}{\ *\ !!!\ Resolution\ is\ only\ 20\ millivolt\ !!!}}
\DoxyCodeLine{00467\ \textcolor{comment}{\ *\ Raw\ reading\ of\ 1.1\ V\ is\ 225\ at\ 5\ V.}}
\DoxyCodeLine{00468\ \textcolor{comment}{\ *\ Raw\ reading\ of\ 1.1\ V\ is\ 221\ at\ 5.1\ V.}}
\DoxyCodeLine{00469\ \textcolor{comment}{\ *\ Raw\ reading\ of\ 1.1\ V\ is\ 214\ at\ 5.25\ V\ (+5\ \%).}}
\DoxyCodeLine{00470\ \textcolor{comment}{\ *\ Raw\ reading\ of\ 1.1\ V\ is\ 204\ at\ 5.5\ V\ (+10\ \%).}}
\DoxyCodeLine{00471\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00472\ \textcolor{keywordtype}{float}\ getVCCVoltageSimple(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{00473\ \ \ \ \ \textcolor{comment}{//\ use\ AVCC\ with\ (optional)\ external\ capacitor\ at\ AREF\ pin\ as\ reference}}
\DoxyCodeLine{00474\ \ \ \ \ \textcolor{keywordtype}{float}\ tVCC\ =\ readADCChannelMultiSamplesWithReference(ADC\_1\_1\_VOLT\_CHANNEL\_MUX,\ DEFAULT,\ 4);}
\DoxyCodeLine{00475\ \ \ \ \ \textcolor{keywordflow}{return}\ ((1023\ *\ 1.1\ *\ 4)\ /\ tVCC);}
\DoxyCodeLine{00476\ \}}
\DoxyCodeLine{00477\ }
\DoxyCodeLine{00478\ \textcolor{comment}{/*}}
\DoxyCodeLine{00479\ \textcolor{comment}{\ *\ !!!\ Function\ without\ handling\ of\ switched\ reference\ and\ channel.!!!}}
\DoxyCodeLine{00480\ \textcolor{comment}{\ *\ Use\ it\ ONLY\ if\ you\ only\ call\ getVCCVoltageSimple()\ or\ getVCCVoltageMillivoltSimple()\ in\ your\ program.}}
\DoxyCodeLine{00481\ \textcolor{comment}{\ *\ !!!\ Resolution\ is\ only\ 20\ millivolt\ !!!}}
\DoxyCodeLine{00482\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00483\ uint16\_t\ getVCCVoltageMillivoltSimple(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{00484\ \ \ \ \ \textcolor{comment}{//\ use\ AVCC\ with\ external\ capacitor\ at\ AREF\ pin\ as\ reference}}
\DoxyCodeLine{00485\ \ \ \ \ uint16\_t\ tVCC\ =\ readADCChannelMultiSamplesWithReference(ADC\_1\_1\_VOLT\_CHANNEL\_MUX,\ DEFAULT,\ 4);}
\DoxyCodeLine{00486\ \ \ \ \ \textcolor{keywordflow}{return}\ ((1023L\ *\ ADC\_INTERNAL\_REFERENCE\_MILLIVOLT\ *\ 4)\ /\ tVCC);}
\DoxyCodeLine{00487\ \}}
\DoxyCodeLine{00488\ }
\DoxyCodeLine{00489\ \textcolor{comment}{/*}}
\DoxyCodeLine{00490\ \textcolor{comment}{\ *\ Gets\ the\ hypothetical\ 14\ bit\ reading\ of\ VCC\ using\ 1.1\ volt\ reference}}
\DoxyCodeLine{00491\ \textcolor{comment}{\ *\ Similar\ to\ getVCCVoltageMillivolt()\ *\ 1023\ /\ 1100}}
\DoxyCodeLine{00492\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00493\ uint16\_t\ getVCCVoltageReadingFor1\_1VoltReference(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{00494\ \ \ \ \ uint16\_t\ tVCC\ =\ waitAndReadADCChannelWithReference(ADC\_1\_1\_VOLT\_CHANNEL\_MUX,\ DEFAULT);}
\DoxyCodeLine{00495\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00496\ \textcolor{comment}{\ \ \ \ \ *\ Do\ not\ switch\ back\ ADMUX\ to\ enable\ checkAndWaitForReferenceAndChannelToSwitch()\ to\ work\ correctly\ for\ the\ next\ measurement}}
\DoxyCodeLine{00497\ \textcolor{comment}{\ \ \ \ \ */}}
\DoxyCodeLine{00498\ \ \ \ \ \textcolor{keywordflow}{return}\ ((1023L\ *\ 1023L)\ /\ tVCC);}
\DoxyCodeLine{00499\ \}}
\DoxyCodeLine{00500\ }
\DoxyCodeLine{00501\ \textcolor{comment}{/*}}
\DoxyCodeLine{00502\ \textcolor{comment}{\ *\ !!!\ Resolution\ is\ only\ 20\ millivolt\ !!!}}
\DoxyCodeLine{00503\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00504\ \textcolor{keywordtype}{float}\ getVCCVoltage(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{00505\ \ \ \ \ \textcolor{keywordflow}{return}\ (getVCCVoltageMillivolt()\ /\ 1000.0);}
\DoxyCodeLine{00506\ \}}
\DoxyCodeLine{00507\ }
\DoxyCodeLine{00508\ \textcolor{comment}{/*}}
\DoxyCodeLine{00509\ \textcolor{comment}{\ *\ Read\ value\ of\ 1.1\ volt\ internal\ channel\ using\ VCC\ (DEFAULT)\ as\ reference.}}
\DoxyCodeLine{00510\ \textcolor{comment}{\ *\ Handles\ reference\ and\ channel\ switching\ by\ introducing\ the\ appropriate\ delays.}}
\DoxyCodeLine{00511\ \textcolor{comment}{\ *\ !!!\ Resolution\ is\ only\ 20\ millivolt\ !!!}}
\DoxyCodeLine{00512\ \textcolor{comment}{\ *\ Raw\ reading\ of\ 1.1\ V\ is\ 225\ at\ 5\ V.}}
\DoxyCodeLine{00513\ \textcolor{comment}{\ *\ Raw\ reading\ of\ 1.1\ V\ is\ 221\ at\ 5.1\ V.}}
\DoxyCodeLine{00514\ \textcolor{comment}{\ *\ Raw\ reading\ of\ 1.1\ V\ is\ 214\ at\ 5.25\ V\ (+5\ \%).}}
\DoxyCodeLine{00515\ \textcolor{comment}{\ *\ Raw\ reading\ of\ 1.1\ V\ is\ 204\ at\ 5.5\ V\ (+10\ \%).}}
\DoxyCodeLine{00516\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00517\ uint16\_t\ getVCCVoltageMillivolt(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{00518\ \ \ \ \ uint16\_t\ tVCC\ =\ waitAndReadADCChannelWithReference(ADC\_1\_1\_VOLT\_CHANNEL\_MUX,\ DEFAULT);}
\DoxyCodeLine{00519\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00520\ \textcolor{comment}{\ \ \ \ \ *\ Do\ not\ switch\ back\ ADMUX\ to\ enable\ checkAndWaitForReferenceAndChannelToSwitch()\ to\ work\ correctly\ for\ the\ next\ measurement}}
\DoxyCodeLine{00521\ \textcolor{comment}{\ \ \ \ \ */}}
\DoxyCodeLine{00522\ \ \ \ \ \textcolor{keywordflow}{return}\ ((1023L\ *\ ADC\_INTERNAL\_REFERENCE\_MILLIVOLT)\ /\ tVCC);}
\DoxyCodeLine{00523\ \}}
\DoxyCodeLine{00524\ }
\DoxyCodeLine{00525\ \textcolor{comment}{/*}}
\DoxyCodeLine{00526\ \textcolor{comment}{\ *\ Does\ not\ set\ sVCCVoltageMillivolt}}
\DoxyCodeLine{00527\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00528\ uint16\_t\ printVCCVoltageMillivolt(Print\ *aSerial)\ \{}
\DoxyCodeLine{00529\ \ \ \ \ aSerial-\/>print(F(\textcolor{stringliteral}{"{}VCC="{}}));}
\DoxyCodeLine{00530\ \ \ \ \ uint16\_t\ tVCCVoltageMillivolt\ =\ getVCCVoltageMillivolt();}
\DoxyCodeLine{00531\ \ \ \ \ aSerial-\/>print(tVCCVoltageMillivolt);}
\DoxyCodeLine{00532\ \ \ \ \ aSerial-\/>println(\textcolor{stringliteral}{"{}\ mV"{}});}
\DoxyCodeLine{00533\ \ \ \ \ \textcolor{keywordflow}{return}\ tVCCVoltageMillivolt;}
\DoxyCodeLine{00534\ \}}
\DoxyCodeLine{00535\ }
\DoxyCodeLine{00536\ \textcolor{keywordtype}{void}\ readAndPrintVCCVoltageMillivolt(Print\ *aSerial)\ \{}
\DoxyCodeLine{00537\ \ \ \ \ aSerial-\/>print(F(\textcolor{stringliteral}{"{}VCC="{}}));}
\DoxyCodeLine{00538\ \ \ \ \ sVCCVoltageMillivolt\ =\ getVCCVoltageMillivolt();}
\DoxyCodeLine{00539\ \ \ \ \ aSerial-\/>print(sVCCVoltageMillivolt);}
\DoxyCodeLine{00540\ \ \ \ \ aSerial-\/>println(\textcolor{stringliteral}{"{}\ mV"{}});}
\DoxyCodeLine{00541\ \}}
\DoxyCodeLine{00542\ \textcolor{comment}{/*}}
\DoxyCodeLine{00543\ \textcolor{comment}{\ *\ !!!\ Function\ without\ handling\ of\ switched\ reference\ and\ channel.!!!}}
\DoxyCodeLine{00544\ \textcolor{comment}{\ *\ Use\ it\ ONLY\ if\ you\ only\ call\ getVCCVoltageSimple()\ or\ getVCCVoltageMillivoltSimple()\ in\ your\ program.}}
\DoxyCodeLine{00545\ \textcolor{comment}{\ *\ !!!\ Resolution\ is\ only\ 20\ millivolt\ !!!}}
\DoxyCodeLine{00546\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00547\ \textcolor{keywordtype}{void}\ readVCCVoltageSimple(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{00548\ \ \ \ \ \textcolor{comment}{//\ use\ AVCC\ with\ (optional)\ external\ capacitor\ at\ AREF\ pin\ as\ reference}}
\DoxyCodeLine{00549\ \ \ \ \ \textcolor{keywordtype}{float}\ tVCC\ =\ readADCChannelMultiSamplesWithReference(ADC\_1\_1\_VOLT\_CHANNEL\_MUX,\ DEFAULT,\ 4);}
\DoxyCodeLine{00550\ \ \ \ \ sVCCVoltage\ =\ (1023\ *\ (((float)\ ADC\_INTERNAL\_REFERENCE\_MILLIVOLT)\ /\ 1000)\ *\ 4)\ /\ tVCC;}
\DoxyCodeLine{00551\ \}}
\DoxyCodeLine{00552\ }
\DoxyCodeLine{00553\ \textcolor{comment}{/*}}
\DoxyCodeLine{00554\ \textcolor{comment}{\ *\ !!!\ Function\ without\ handling\ of\ switched\ reference\ and\ channel.!!!}}
\DoxyCodeLine{00555\ \textcolor{comment}{\ *\ Use\ it\ ONLY\ if\ you\ only\ call\ getVCCVoltageSimple()\ or\ getVCCVoltageMillivoltSimple()\ in\ your\ program.}}
\DoxyCodeLine{00556\ \textcolor{comment}{\ *\ !!!\ Resolution\ is\ only\ 20\ millivolt\ !!!}}
\DoxyCodeLine{00557\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00558\ \textcolor{keywordtype}{void}\ readVCCVoltageMillivoltSimple(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{00559\ \ \ \ \ \textcolor{comment}{//\ use\ AVCC\ with\ external\ capacitor\ at\ AREF\ pin\ as\ reference}}
\DoxyCodeLine{00560\ \ \ \ \ uint16\_t\ tVCCVoltageMillivoltRaw\ =\ readADCChannelMultiSamplesWithReference(ADC\_1\_1\_VOLT\_CHANNEL\_MUX,\ DEFAULT,\ 4);}
\DoxyCodeLine{00561\ \ \ \ \ sVCCVoltageMillivolt\ =\ (1023L\ *\ ADC\_INTERNAL\_REFERENCE\_MILLIVOLT\ *\ 4)\ /\ tVCCVoltageMillivoltRaw;}
\DoxyCodeLine{00562\ \}}
\DoxyCodeLine{00563\ }
\DoxyCodeLine{00564\ \textcolor{comment}{/*}}
\DoxyCodeLine{00565\ \textcolor{comment}{\ *\ !!!\ Resolution\ is\ only\ 20\ millivolt\ !!!}}
\DoxyCodeLine{00566\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00567\ \textcolor{keywordtype}{void}\ readVCCVoltage(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{00568\ \ \ \ \ sVCCVoltage\ =\ getVCCVoltageMillivolt()\ /\ 1000.0;}
\DoxyCodeLine{00569\ \}}
\DoxyCodeLine{00570\ }
\DoxyCodeLine{00571\ \textcolor{comment}{/*}}
\DoxyCodeLine{00572\ \textcolor{comment}{\ *\ Read\ value\ of\ 1.1\ volt\ internal\ channel\ using\ VCC\ (DEFAULT)\ as\ reference.}}
\DoxyCodeLine{00573\ \textcolor{comment}{\ *\ Handles\ reference\ and\ channel\ switching\ by\ introducing\ the\ appropriate\ delays.}}
\DoxyCodeLine{00574\ \textcolor{comment}{\ *\ !!!\ Resolution\ is\ only\ 20\ millivolt\ !!!}}
\DoxyCodeLine{00575\ \textcolor{comment}{\ *\ Sets\ also\ the\ sVCCVoltageMillivolt\ variable.}}
\DoxyCodeLine{00576\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00577\ \textcolor{keywordtype}{void}\ readVCCVoltageMillivolt(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{00578\ \ \ \ \ uint16\_t\ tVCCVoltageMillivoltRaw\ =\ waitAndReadADCChannelWithReference(ADC\_1\_1\_VOLT\_CHANNEL\_MUX,\ DEFAULT);}
\DoxyCodeLine{00579\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00580\ \textcolor{comment}{\ \ \ \ \ *\ Do\ not\ switch\ back\ ADMUX\ to\ enable\ checkAndWaitForReferenceAndChannelToSwitch()\ to\ work\ correctly\ for\ the\ next\ measurement}}
\DoxyCodeLine{00581\ \textcolor{comment}{\ \ \ \ \ */}}
\DoxyCodeLine{00582\ \ \ \ \ sVCCVoltageMillivolt\ =\ (1023L\ *\ ADC\_INTERNAL\_REFERENCE\_MILLIVOLT)\ /\ tVCCVoltageMillivoltRaw;}
\DoxyCodeLine{00583\ \}}
\DoxyCodeLine{00584\ }
\DoxyCodeLine{00585\ \textcolor{comment}{/*}}
\DoxyCodeLine{00586\ \textcolor{comment}{\ *\ Get\ voltage\ at\ ADC\ channel\ aADCChannelForVoltageMeasurement}}
\DoxyCodeLine{00587\ \textcolor{comment}{\ *\ aVCCVoltageMillivolt\ is\ assumed\ as\ reference\ voltage}}
\DoxyCodeLine{00588\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00589\ uint16\_t\ getVoltageMillivolt(uint16\_t\ aVCCVoltageMillivolt,\ uint8\_t\ aADCChannelForVoltageMeasurement)\ \{}
\DoxyCodeLine{00590\ \ \ \ \ uint16\_t\ tInputVoltageRaw\ =\ waitAndReadADCChannelWithReference(aADCChannelForVoltageMeasurement,\ DEFAULT);}
\DoxyCodeLine{00591\ \ \ \ \ \textcolor{keywordflow}{return}\ (aVCCVoltageMillivolt\ *\ (uint32\_t)\ tInputVoltageRaw)\ /\ 1023;}
\DoxyCodeLine{00592\ \}}
\DoxyCodeLine{00593\ }
\DoxyCodeLine{00594\ \textcolor{comment}{/*}}
\DoxyCodeLine{00595\ \textcolor{comment}{\ *\ Get\ voltage\ at\ ADC\ channel\ aADCChannelForVoltageMeasurement}}
\DoxyCodeLine{00596\ \textcolor{comment}{\ *\ Reference\ voltage\ VCC\ is\ determined\ just\ before}}
\DoxyCodeLine{00597\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00598\ uint16\_t\ getVoltageMillivolt(uint8\_t\ aADCChannelForVoltageMeasurement)\ \{}
\DoxyCodeLine{00599\ \ \ \ \ uint16\_t\ tInputVoltageRaw\ =\ waitAndReadADCChannelWithReference(aADCChannelForVoltageMeasurement,\ DEFAULT);}
\DoxyCodeLine{00600\ \ \ \ \ \textcolor{keywordflow}{return}\ (getVCCVoltageMillivolt()\ *\ (uint32\_t)\ tInputVoltageRaw)\ /\ 1023;}
\DoxyCodeLine{00601\ \}}
\DoxyCodeLine{00602\ }
\DoxyCodeLine{00603\ uint16\_t\ getVoltageMillivoltWith\_1\_1VoltReference(uint8\_t\ aADCChannelForVoltageMeasurement)\ \{}
\DoxyCodeLine{00604\ \ \ \ \ uint16\_t\ tInputVoltageRaw\ =\ waitAndReadADCChannelWithReference(aADCChannelForVoltageMeasurement,\ INTERNAL);}
\DoxyCodeLine{00605\ \ \ \ \ \textcolor{keywordflow}{return}\ (ADC\_INTERNAL\_REFERENCE\_MILLIVOLT\ *\ (uint32\_t)\ tInputVoltageRaw)\ /\ 1023;}
\DoxyCodeLine{00606\ \}}
\DoxyCodeLine{00607\ }
\DoxyCodeLine{00608\ \textcolor{comment}{/*}}
\DoxyCodeLine{00609\ \textcolor{comment}{\ *\ Return\ true\ if\ sVCCVoltageMillivolt\ is\ >\ 4.3\ V\ and\ <\ 4.95\ V}}
\DoxyCodeLine{00610\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00611\ \textcolor{keywordtype}{bool}\ isVCCUSBPowered()\ \{}
\DoxyCodeLine{00612\ \ \ \ \ readVCCVoltageMillivolt();}
\DoxyCodeLine{00613\ \ \ \ \ \textcolor{keywordflow}{return}\ (VOLTAGE\_USB\_POWERED\_LOWER\_THRESHOLD\_MILLIVOLT\ <\ sVCCVoltageMillivolt}
\DoxyCodeLine{00614\ \ \ \ \ \ \ \ \ \ \ \ \ \&\&\ sVCCVoltageMillivolt\ <\ VOLTAGE\_USB\_POWERED\_UPPER\_THRESHOLD\_MILLIVOLT);}
\DoxyCodeLine{00615\ \}}
\DoxyCodeLine{00616\ }
\DoxyCodeLine{00617\ \textcolor{comment}{/*}}
\DoxyCodeLine{00618\ \textcolor{comment}{\ *\ Return\ true\ if\ sVCCVoltageMillivolt\ is\ >\ 4.3\ V\ and\ <\ 4.95\ V}}
\DoxyCodeLine{00619\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00620\ \textcolor{keywordtype}{bool}\ isVCCUSBPowered(Print\ *aSerial)\ \{}
\DoxyCodeLine{00621\ \ \ \ \ readVCCVoltageMillivolt();}
\DoxyCodeLine{00622\ \ \ \ \ aSerial-\/>print(F(\textcolor{stringliteral}{"{}USB\ powered\ is\ "{}}));}
\DoxyCodeLine{00623\ \ \ \ \ \textcolor{keywordtype}{bool}\ tReturnValue;}
\DoxyCodeLine{00624\ \ \ \ \ \textcolor{keywordflow}{if}\ (VOLTAGE\_USB\_POWERED\_LOWER\_THRESHOLD\_MILLIVOLT}
\DoxyCodeLine{00625\ \ \ \ \ \ \ \ \ \ \ \ \ <\ sVCCVoltageMillivolt\&\&\ sVCCVoltageMillivolt\ <\ VOLTAGE\_USB\_POWERED\_UPPER\_THRESHOLD\_MILLIVOLT)\ \{}
\DoxyCodeLine{00626\ \ \ \ \ \ \ \ \ tReturnValue\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00627\ \ \ \ \ \ \ \ \ aSerial-\/>print(F(\textcolor{stringliteral}{"{}true\ "{}}));}
\DoxyCodeLine{00628\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00629\ \ \ \ \ \ \ \ \ tReturnValue\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00630\ \ \ \ \ \ \ \ \ aSerial-\/>print(F(\textcolor{stringliteral}{"{}false\ "{}}));}
\DoxyCodeLine{00631\ \ \ \ \ \}}
\DoxyCodeLine{00632\ \ \ \ \ printVCCVoltageMillivolt(aSerial);}
\DoxyCodeLine{00633\ \ \ \ \ \textcolor{keywordflow}{return}\ tReturnValue;}
\DoxyCodeLine{00634\ \}}
\DoxyCodeLine{00635\ }
\DoxyCodeLine{00636\ \textcolor{comment}{/*}}
\DoxyCodeLine{00637\ \textcolor{comment}{\ *\ @\ return\ true\ only\ once,\ when\ VCC\_UNDERVOLTAGE\_CHECKS\_BEFORE\_STOP\ (6)\ times\ voltage\ too\ low\ -\/>\ shutdown}}
\DoxyCodeLine{00638\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00639\ \textcolor{keywordtype}{bool}\ isVCCUndervoltageMultipleTimes()\ \{}
\DoxyCodeLine{00640\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00641\ \textcolor{comment}{\ \ \ \ \ *\ Check\ VCC\ every\ VCC\_CHECK\_PERIOD\_MILLIS\ (10)\ seconds}}
\DoxyCodeLine{00642\ \textcolor{comment}{\ \ \ \ \ */}}
\DoxyCodeLine{00643\ }
\DoxyCodeLine{00644\ \ \ \ \ \textcolor{keywordflow}{if}\ (millis()\ -\/\ sLastVCCCheckMillis\ >=\ VCC\_CHECK\_PERIOD\_MILLIS)\ \{}
\DoxyCodeLine{00645\ \ \ \ \ \ \ \ \ sLastVCCCheckMillis\ =\ millis();}
\DoxyCodeLine{00646\ }
\DoxyCodeLine{00647\ \textcolor{preprocessor}{\#\ \ if\ defined(INFO)}}
\DoxyCodeLine{00648\ \ \ \ \ \ \ \ \ readAndPrintVCCVoltageMillivolt(\&Serial);}
\DoxyCodeLine{00649\ \textcolor{preprocessor}{\#\ \ else}}
\DoxyCodeLine{00650\ \ \ \ \ \ \ \ \ readVCCVoltageMillivolt();}
\DoxyCodeLine{00651\ \textcolor{preprocessor}{\#\ \ endif}}
\DoxyCodeLine{00652\ }
\DoxyCodeLine{00653\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (sVCCTooLowCounter\ <\ VCC\_UNDERVOLTAGE\_CHECKS\_BEFORE\_STOP)\ \{}
\DoxyCodeLine{00654\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00655\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ *\ Do\ not\ check\ again\ if\ shutdown\ has\ happened}}
\DoxyCodeLine{00656\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ */}}
\DoxyCodeLine{00657\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (sVCCVoltageMillivolt\ >\ VCC\_UNDERVOLTAGE\_THRESHOLD\_MILLIVOLT)\ \{}
\DoxyCodeLine{00658\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ sVCCTooLowCounter\ =\ 0;\ \textcolor{comment}{//\ reset\ counter}}
\DoxyCodeLine{00659\ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00660\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00661\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ *\ Voltage\ too\ low,\ wait\ VCC\_UNDERVOLTAGE\_CHECKS\_BEFORE\_STOP\ (6)\ times\ and\ then\ shut\ down.}}
\DoxyCodeLine{00662\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ */}}
\DoxyCodeLine{00663\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (sVCCVoltageMillivolt\ <\ VCC\_EMERGENCY\_UNDERVOLTAGE\_THRESHOLD\_MILLIVOLT)\ \{}
\DoxyCodeLine{00664\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ emergency\ shutdown}}
\DoxyCodeLine{00665\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ sVCCTooLowCounter\ =\ VCC\_UNDERVOLTAGE\_CHECKS\_BEFORE\_STOP;}
\DoxyCodeLine{00666\ \textcolor{preprocessor}{\#\ \ if\ defined(INFO)}}
\DoxyCodeLine{00667\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Serial.println(}
\DoxyCodeLine{00668\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ F(}
\DoxyCodeLine{00669\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}Voltage\ <\ "{}}\ STR(VCC\_EMERGENCY\_UNDERVOLTAGE\_THRESHOLD\_MILLIVOLT)\ \textcolor{stringliteral}{"{}\ mV\ detected\ -\/>\ emergency\ shutdown"{}}));}
\DoxyCodeLine{00670\ \textcolor{preprocessor}{\#\ \ endif}}
\DoxyCodeLine{00671\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00672\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ sVCCTooLowCounter++;}
\DoxyCodeLine{00673\ \textcolor{preprocessor}{\#\ \ if\ defined(INFO)}}
\DoxyCodeLine{00674\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Serial.print(F(\textcolor{stringliteral}{"{}Voltage\ <\ "{}}\ STR(VCC\_UNDERVOLTAGE\_THRESHOLD\_MILLIVOLT)\ \textcolor{stringliteral}{"{}\ mV\ detected:\ "{}}));}
\DoxyCodeLine{00675\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Serial.print(VCC\_UNDERVOLTAGE\_CHECKS\_BEFORE\_STOP\ -\/\ sVCCTooLowCounter);}
\DoxyCodeLine{00676\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Serial.println(F(\textcolor{stringliteral}{"{}\ tries\ left"{}}));}
\DoxyCodeLine{00677\ \textcolor{preprocessor}{\#\ \ endif}}
\DoxyCodeLine{00678\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00679\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (sVCCTooLowCounter\ ==\ VCC\_UNDERVOLTAGE\_CHECKS\_BEFORE\_STOP)\ \{}
\DoxyCodeLine{00680\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00681\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ *\ 6\ times\ voltage\ too\ low\ -\/>\ return\ signal\ for\ shutdown\ etc.}}
\DoxyCodeLine{00682\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ */}}
\DoxyCodeLine{00683\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00684\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00685\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00686\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00687\ \ \ \ \ \}}
\DoxyCodeLine{00688\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00689\ \}}
\DoxyCodeLine{00690\ }
\DoxyCodeLine{00691\ \textcolor{comment}{/*}}
\DoxyCodeLine{00692\ \textcolor{comment}{\ *\ Return\ true\ if\ VCC\_EMERGENCY\_UNDERVOLTAGE\_THRESHOLD\_MILLIVOLT\ (3\ V)\ reached}}
\DoxyCodeLine{00693\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00694\ \textcolor{keywordtype}{bool}\ isVCCUndervoltage()\ \{}
\DoxyCodeLine{00695\ \ \ \ \ readVCCVoltageMillivolt();}
\DoxyCodeLine{00696\ \ \ \ \ \textcolor{keywordflow}{return}\ (sVCCVoltageMillivolt\ <\ VCC\_UNDERVOLTAGE\_THRESHOLD\_MILLIVOLT);}
\DoxyCodeLine{00697\ \}}
\DoxyCodeLine{00698\ }
\DoxyCodeLine{00699\ \textcolor{comment}{/*}}
\DoxyCodeLine{00700\ \textcolor{comment}{\ *\ Return\ true\ if\ VCC\_EMERGENCY\_UNDERVOLTAGE\_THRESHOLD\_MILLIVOLT\ (3\ V)\ reached}}
\DoxyCodeLine{00701\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00702\ \textcolor{keywordtype}{bool}\ isVCCEmergencyUndervoltage()\ \{}
\DoxyCodeLine{00703\ \ \ \ \ readVCCVoltageMillivolt();}
\DoxyCodeLine{00704\ \ \ \ \ \textcolor{keywordflow}{return}\ (sVCCVoltageMillivolt\ <\ VCC\_EMERGENCY\_UNDERVOLTAGE\_THRESHOLD\_MILLIVOLT);}
\DoxyCodeLine{00705\ \}}
\DoxyCodeLine{00706\ }
\DoxyCodeLine{00707\ \textcolor{keywordtype}{void}\ resetCounterForVCCUndervoltageMultipleTimes()\ \{}
\DoxyCodeLine{00708\ \ \ \ \ sVCCTooLowCounter\ =\ 0;}
\DoxyCodeLine{00709\ \}}
\DoxyCodeLine{00710\ }
\DoxyCodeLine{00711\ \textcolor{comment}{/*}}
\DoxyCodeLine{00712\ \textcolor{comment}{\ *\ Recommended\ VCC\ is\ 1.8\ V\ to\ 5.5\ V,\ absolute\ maximum\ VCC\ is\ 6.0\ V.}}
\DoxyCodeLine{00713\ \textcolor{comment}{\ *\ Check\ for\ 5.25\ V,\ because\ such\ overvoltage\ is\ quite\ unlikely\ to\ happen\ during\ regular\ operation.}}
\DoxyCodeLine{00714\ \textcolor{comment}{\ *\ Raw\ reading\ of\ 1.1\ V\ is\ 225\ at\ 5\ V.}}
\DoxyCodeLine{00715\ \textcolor{comment}{\ *\ Raw\ reading\ of\ 1.1\ V\ is\ 221\ at\ 5.1\ V.}}
\DoxyCodeLine{00716\ \textcolor{comment}{\ *\ Raw\ reading\ of\ 1.1\ V\ is\ 214\ at\ 5.25\ V\ (+5\ \%).}}
\DoxyCodeLine{00717\ \textcolor{comment}{\ *\ Raw\ reading\ of\ 1.1\ V\ is\ 204\ at\ 5.5\ V\ (+10\ \%).}}
\DoxyCodeLine{00718\ \textcolor{comment}{\ *\ Raw\ reading\ of\ 1.1\ V\ is\ 1126000\ /\ VCC\_MILLIVOLT}}
\DoxyCodeLine{00719\ \textcolor{comment}{\ *\ @return\ true\ if\ 5\ \%\ overvoltage\ reached}}
\DoxyCodeLine{00720\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00721\ \textcolor{keywordtype}{bool}\ isVCCOvervoltage()\ \{}
\DoxyCodeLine{00722\ \ \ \ \ readVCCVoltageMillivolt();}
\DoxyCodeLine{00723\ \ \ \ \ \textcolor{keywordflow}{return}\ (sVCCVoltageMillivolt\ >\ VCC\_OVERVOLTAGE\_THRESHOLD\_MILLIVOLT);}
\DoxyCodeLine{00724\ \}}
\DoxyCodeLine{00725\ \textcolor{keywordtype}{bool}\ isVCCOvervoltageSimple()\ \{}
\DoxyCodeLine{00726\ \ \ \ \ readVCCVoltageMillivoltSimple();}
\DoxyCodeLine{00727\ \ \ \ \ \textcolor{keywordflow}{return}\ (sVCCVoltageMillivolt\ >\ VCC\_OVERVOLTAGE\_THRESHOLD\_MILLIVOLT);}
\DoxyCodeLine{00728\ \}}
\DoxyCodeLine{00729\ }
\DoxyCodeLine{00730\ \textcolor{comment}{//\ Version\ not\ using\ readVCCVoltageMillivoltSimple()}}
\DoxyCodeLine{00731\ \textcolor{keywordtype}{bool}\ isVCCTooHighSimple()\ \{}
\DoxyCodeLine{00732\ \ \ \ \ ADMUX\ =\ ADC\_1\_1\_VOLT\_CHANNEL\_MUX\ |\ (DEFAULT\ <<\ SHIFT\_VALUE\_FOR\_REFERENCE);}
\DoxyCodeLine{00733\ \textcolor{comment}{//\ ADCSRB\ =\ 0;\ //\ Only\ active\ if\ ADATE\ is\ set\ to\ 1.}}
\DoxyCodeLine{00734\ \textcolor{comment}{//\ ADSC-\/StartConversion\ ADIF-\/Reset\ Interrupt\ Flag\ -\/\ NOT\ free\ running\ mode}}
\DoxyCodeLine{00735\ \ \ \ \ ADCSRA\ =\ (\_BV(ADEN)\ |\ \_BV(ADSC)\ |\ \_BV(ADIF)\ |\ ADC\_PRESCALE128);\ \textcolor{comment}{//\ \ 128\ -\/>\ 104\ microseconds\ per\ ADC\ conversion\ at\ 16\ MHz\ -\/-\/-\/\ Arduino\ default}}
\DoxyCodeLine{00736\ \textcolor{comment}{//\ wait\ for\ single\ conversion\ to\ finish}}
\DoxyCodeLine{00737\ \ \ \ \ loop\_until\_bit\_is\_clear(ADCSRA,\ ADSC);}
\DoxyCodeLine{00738\ }
\DoxyCodeLine{00739\ \textcolor{comment}{//\ Get\ value}}
\DoxyCodeLine{00740\ \ \ \ \ uint16\_t\ tRawValue\ =\ ADCL\ |\ (ADCH\ <<\ 8);}
\DoxyCodeLine{00741\ }
\DoxyCodeLine{00742\ \ \ \ \ \textcolor{keywordflow}{return}\ tRawValue\ <\ 1126000\ /\ VCC\_OVERVOLTAGE\_THRESHOLD\_MILLIVOLT;}
\DoxyCodeLine{00743\ \}}
\DoxyCodeLine{00744\ }
\DoxyCodeLine{00745\ \textcolor{comment}{/*}}
\DoxyCodeLine{00746\ \textcolor{comment}{\ *\ Temperature\ sensor\ is\ enabled\ by\ selecting\ the\ appropriate\ channel.}}
\DoxyCodeLine{00747\ \textcolor{comment}{\ *\ Different\ formula\ for\ 328P\ and\ 328PB!}}
\DoxyCodeLine{00748\ \textcolor{comment}{\ *\ !!!\ Function\ without\ handling\ of\ switched\ reference\ and\ channel.!!!}}
\DoxyCodeLine{00749\ \textcolor{comment}{\ *\ Use\ it\ ONLY\ if\ you\ only\ use\ INTERNAL\ reference\ (e.g.\ only\ call\ getTemperatureSimple())\ in\ your\ program.}}
\DoxyCodeLine{00750\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00751\ \textcolor{keywordtype}{float}\ getCPUTemperatureSimple(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{00752\ \textcolor{preprocessor}{\#if\ defined(\_\_AVR\_ATmega1280\_\_)\ ||\ defined(\_\_AVR\_ATmega2560\_\_)}}
\DoxyCodeLine{00753\ \ \ \ \ \textcolor{keywordflow}{return}\ 0.0;}
\DoxyCodeLine{00754\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00755\ \ \ \ \ \textcolor{comment}{//\ use\ internal\ 1.1\ volt\ as\ reference.\ 4\ times\ oversample.\ Assume\ the\ signal\ has\ noise,\ but\ never\ verified\ :-\/(}}
\DoxyCodeLine{00756\ \ \ \ \ uint16\_t\ tTemperatureRaw\ =\ readADCChannelWithReferenceOversample(ADC\_TEMPERATURE\_CHANNEL\_MUX,\ INTERNAL,\ 2);}
\DoxyCodeLine{00757\ \textcolor{preprocessor}{\#if\ defined(LOCAL\_DEBUG)}}
\DoxyCodeLine{00758\ \ \ \ \ Serial.print(F(\textcolor{stringliteral}{"{}TempRaw="{}}));}
\DoxyCodeLine{00759\ \ \ \ \ Serial.println(tTemperatureRaw);}
\DoxyCodeLine{00760\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00761\ }
\DoxyCodeLine{00762\ \textcolor{preprocessor}{\#if\ defined(\_\_AVR\_ATmega328PB\_\_)}}
\DoxyCodeLine{00763\ \ \ \ \ tTemperatureRaw\ -\/=\ 245;}
\DoxyCodeLine{00764\ \ \ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{float})tTemperatureRaw;}
\DoxyCodeLine{00765\ \textcolor{preprocessor}{\#elif\ defined(\_\_AVR\_ATtiny85\_\_)}}
\DoxyCodeLine{00766\ \ \ \ \ tTemperatureRaw\ -\/=\ 273;\ \textcolor{comment}{//\ 273\ and\ 1.1666\ are\ values\ from\ the\ datasheet}}
\DoxyCodeLine{00767\ \ \ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{float})tTemperatureRaw\ /\ 1.1666;}
\DoxyCodeLine{00768\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00769\ \ \ \ \ tTemperatureRaw\ -\/=\ 317;}
\DoxyCodeLine{00770\ \ \ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{float})\ tTemperatureRaw\ /\ 1.22;}
\DoxyCodeLine{00771\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00772\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00773\ \}}
\DoxyCodeLine{00774\ }
\DoxyCodeLine{00775\ \textcolor{comment}{/*}}
\DoxyCodeLine{00776\ \textcolor{comment}{\ *\ Handles\ usage\ of\ 1.1\ V\ reference\ and\ channel\ switching\ by\ introducing\ the\ appropriate\ delays.}}
\DoxyCodeLine{00777\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00778\ \textcolor{keywordtype}{float}\ getTemperature(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{00779\ \ \ \ \ \textcolor{keywordflow}{return}\ getCPUTemperature();}
\DoxyCodeLine{00780\ \}}
\DoxyCodeLine{00781\ \textcolor{keywordtype}{float}\ getCPUTemperature(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{00782\ \textcolor{preprocessor}{\#if\ defined(\_\_AVR\_ATmega1280\_\_)\ ||\ defined(\_\_AVR\_ATmega2560\_\_)}}
\DoxyCodeLine{00783\ \ \ \ \ \textcolor{keywordflow}{return}\ 0.0;}
\DoxyCodeLine{00784\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00785\ \ \ \ \ \textcolor{comment}{//\ use\ internal\ 1.1\ volt\ as\ reference}}
\DoxyCodeLine{00786\ \ \ \ \ checkAndWaitForReferenceAndChannelToSwitch(ADC\_TEMPERATURE\_CHANNEL\_MUX,\ INTERNAL);}
\DoxyCodeLine{00787\ \ \ \ \ \textcolor{keywordflow}{return}\ getCPUTemperatureSimple();}
\DoxyCodeLine{00788\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00789\ \}}
\DoxyCodeLine{00790\ }
\DoxyCodeLine{00791\ \textcolor{preprocessor}{\#else\ }\textcolor{comment}{//\ defined(ADC\_UTILS\_ARE\_AVAILABLE)}}
\DoxyCodeLine{00792\ \textcolor{comment}{//\ Dummy\ definition\ of\ functions\ defined\ in\ ADCUtils\ to\ compile\ examples\ for\ non\ AVR\ platforms\ without\ errors}}
\DoxyCodeLine{00793\ \textcolor{comment}{/*}}
\DoxyCodeLine{00794\ \textcolor{comment}{\ *\ Persistent\ storage\ for\ VCC\ value}}
\DoxyCodeLine{00795\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00796\ \textcolor{keywordtype}{float}\ sVCCVoltage;}
\DoxyCodeLine{00797\ uint16\_t\ sVCCVoltageMillivolt;}
\DoxyCodeLine{00798\ }
\DoxyCodeLine{00799\ uint16\_t\ getVCCVoltageMillivoltSimple(\textcolor{keywordtype}{void})\{}
\DoxyCodeLine{00800\ \ \ \ \ \textcolor{keywordflow}{return}\ 3300;}
\DoxyCodeLine{00801\ \}}
\DoxyCodeLine{00802\ }
\DoxyCodeLine{00803\ uint16\_t\ readADCChannelWithReferenceOversample(uint8\_t\ aChannelNumber\ \_\_attribute\_\_((unused)),}
\DoxyCodeLine{00804\ \ \ \ \ \ \ \ \ uint8\_t\ aReference\ \_\_attribute\_\_((unused)),\ uint8\_t\ aOversampleExponent\ \_\_attribute\_\_((unused)))\ \{}
\DoxyCodeLine{00805\ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00806\ \}}
\DoxyCodeLine{00807\ \textcolor{keywordtype}{float}\ getCPUTemperature()\ \{}
\DoxyCodeLine{00808\ \ \ \ \ \textcolor{keywordflow}{return}\ 20.0;}
\DoxyCodeLine{00809\ \}}
\DoxyCodeLine{00810\ \textcolor{keywordtype}{float}\ getVCCVoltage()\ \{}
\DoxyCodeLine{00811\ \ \ \ \ \textcolor{keywordflow}{return}\ 3.3;}
\DoxyCodeLine{00812\ \}}
\DoxyCodeLine{00813\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ defined(ADC\_UTILS\_ARE\_AVAILABLE)}}
\DoxyCodeLine{00814\ }
\DoxyCodeLine{00815\ \textcolor{preprocessor}{\#if\ defined(LOCAL\_DEBUG)}}
\DoxyCodeLine{00816\ \textcolor{preprocessor}{\#undef\ LOCAL\_DEBUG}}
\DoxyCodeLine{00817\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00818\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ \_ADC\_UTILS\_HPP}}

\end{DoxyCode}
